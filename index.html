<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Gizmotech ATR-72 Controller</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0b0e14;
    --card: #161b22;
    --border: #30363d;
    --gt-orange: #ff8c00; /* Gizmotech Identity */
    --gt-orange-dim: #4d2a00;
    --cyan: #00d4ff;
    --green: #238636;
    --red: #da3633;
    --text: #c9d1d9;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; }
  
  body {
    background: var(--bg);
    font-family: 'Inter', sans-serif;
    color: var(--text);
    height: 100dvh; width: 100vw;
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* Header */
  .header {
    padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(22, 27, 34, 0.8);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    z-index: 100;
  }
  .brand { font-weight: 800; font-size: 16px; letter-spacing: 1px; color: var(--gt-orange); }
  .brand span { color: var(--text); font-weight: 400; }
  
  .status-group { display: flex; gap: 10px; align-items: center; }
  .status-pill {
    padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600;
    background: var(--card); border: 1px solid var(--border);
    display: flex; align-items: center; gap: 6px;
  }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
  .dot.active { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .dot.warn { background: var(--gt-orange); animation: blink 0.8s infinite; }

  /* Main Layout */
  .main-ctrl {
    flex: 1; display: flex; padding: 20px; gap: 20px; align-items: stretch;
  }

  /* Vertical Throttle */
  .throttle-container {
    width: 70px; display: flex; flex-direction: column; align-items: center; gap: 10px;
  }
  .th-track {
    flex: 1; width: 45px; background: var(--card); border: 1px solid var(--border);
    border-radius: 25px; position: relative; overflow: hidden; touch-action: none;
  }
  .th-fill {
    position: absolute; bottom: 0; width: 100%;
    background: linear-gradient(to top, var(--gt-orange-dim), var(--gt-orange));
    transition: height 0.05s;
  }
  .th-handle {
    position: absolute; left: 50%; transform: translate(-50%, 50%);
    width: 55px; height: 55px; background: var(--text); border-radius: 50%;
    border: 4px solid var(--bg); box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    color: var(--bg); font-weight: 800; font-size: 12px; transition: bottom 0.05s;
  }

  /* Center Display */
  .center-display {
    flex: 1; display: flex; flex-direction: column; gap: 15px;
  }
  .horizon-card {
    flex: 1; background: var(--card); border: 1px solid var(--border);
    border-radius: 24px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; position: relative;
    overflow: hidden;
  }
  canvas#horizon { width: 100%; height: 100%; max-width: 220px; }

  /* Data Grid */
  .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .data-card {
    background: var(--card); border: 1px solid var(--border);
    padding: 12px; border-radius: 16px; text-align: center;
  }
  .data-label { font-size: 9px; color: #8b949e; text-transform: uppercase; margin-bottom: 4px; }
  .data-value { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; }

  /* Footer Actions */
  .footer {
    padding: 20px; display: flex; gap: 12px;
  }
  .btn {
    flex: 1; padding: 15px; border-radius: 16px; border: none;
    font-weight: 700; font-size: 13px; cursor: pointer;
    transition: all 0.2s; font-family: 'Inter', sans-serif;
  }
  .btn-primary { background: var(--gt-orange); color: white; }
  .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--red); color: white; }

  /* Overlay */
  .overlay {
    position: fixed; inset: 0; background: rgba(11, 14, 20, 0.95);
    z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 30px;
  }
  .modal {
    background: var(--card); border: 1px solid var(--border);
    padding: 30px; border-radius: 28px; width: 100%; max-width: 350px; text-align: center;
  }
  .hidden { display: none !important; }

  @keyframes blink { 50% { opacity: 0.3; } }
</style>
</head>
<body>

<div class="header">
  <div class="brand">GIZMOTECH <span>ATR-72</span></div>
  <div class="status-group">
    <div class="status-pill"><div class="dot" id="wsDot"></div><span id="wsLbl">OFFLINE</span></div>
    <div id="pingTxt" style="font-size: 10px; color: #8b949e;">-- ms</div>
  </div>
</div>

<div class="main-ctrl">
  <div class="throttle-container">
    <div class="th-track" id="thTrack">
      <div class="th-fill" id="thFill" style="height: 0%;"></div>
      <div class="th-handle" id="thHandle" style="bottom: 0%;">0%</div>
    </div>
    <div class="data-label">Throttle</div>
  </div>

  <div class="center-display">
    <div class="horizon-card">
      <canvas id="horizon"></canvas>
      <div style="position:absolute; top:10px; right:15px; font-size:10px; color:var(--gt-orange)" id="dSts">SAFE</div>
    </div>
    
    <div class="data-grid">
      <div class="data-card"><div class="data-label">Roll</div><div class="data-value" id="dRoll">0Â°</div></div>
      <div class="data-card"><div class="data-label">Pitch</div><div class="data-value" id="dPitch">0Â°</div></div>
    </div>
  </div>
</div>

<div class="footer">
  <button class="btn btn-secondary" onclick="calibrate()">CALIBRATE</button>
  <button class="btn btn-primary" id="armBtn" onclick="toggleArm()">ARM SYSTEM</button>
  <button class="btn btn-secondary" onclick="openCfg()">âš™</button>
</div>

<div class="overlay" id="splashOv">
  <div class="modal">
    <div style="font-size: 40px; margin-bottom: 20px;">ðŸš€</div>
    <h2 style="margin-bottom: 10px;">Gizmotech RC</h2>
    <p style="font-size: 13px; color: #8b949e; margin-bottom: 25px; line-height: 1.6;">
      Gunakan mode portrait. Throttle di kiri, kemiringan HP untuk kendali sayap & elevator.
    </p>
    <button class="btn btn-primary" style="width: 100%;" onclick="startApp()">START SENSORS</button>
  </div>
</div>

<div class="overlay hidden" id="cfgOv">
  <div class="modal" style="text-align: left;">
    <h3 style="margin-bottom: 15px;">Settings</h3>
    <label style="font-size: 11px; color: #8b949e;">ESP IP Address</label>
    <input id="cIp" value="192.168.4.1" style="width:100%; background:#0b0e14; border:1px solid var(--border); color:white; padding:10px; border-radius:8px; margin: 5px 0 15px;">
    <button class="btn btn-primary" style="width: 100%;" onclick="saveCfg()">SAVE & CONNECT</button>
  </div>
</div>

<div id="dbg" style="position:fixed; bottom:5px; width:100%; text-align:center; font-size:9px; color:#444;"></div>

<script>
let ws=null, armed=false, throttle=0;
let rollOff=0, pitchOff=0, curRoll=0, curPitch=0;
let cfg={ip:'192.168.4.1', port:81, rate:50};

const canvas=document.getElementById('horizon');
const ctx=canvas.getContext('2d');

// --- AUTO RECONNECT LOGIC ---
function connect() {
  if(ws) { ws.close(); ws=null; }
  updateWsStatus('warn', 'CONNECTING...');
  
  ws = new WebSocket(`ws://${cfg.ip}:${cfg.port}`);
  
  ws.onopen = () => {
    updateWsStatus('active', 'CONNECTED');
    startDataLoop();
  };

  ws.onclose = () => {
    updateWsStatus('', 'OFFLINE');
    stopDataLoop();
    // Auto reconnect every 3 seconds
    setTimeout(connect, 3000);
  };

  ws.onerror = () => updateWsStatus('red', 'ERROR');
  
  ws.onmessage = (e) => {
    if(e.data === 'pong') document.getElementById('pingTxt').textContent = 'OK';
  };
}

function updateWsStatus(state, label) {
  const dot = document.getElementById('wsDot');
  dot.className = 'dot ' + state;
  document.getElementById('wsLbl').textContent = label;
}

// --- VERTICAL THROTTLE LOGIC ---
const thTrack = document.getElementById('thTrack');
thTrack.addEventListener('touchmove', e => {
  const rect = thTrack.getBoundingClientRect();
  const touchY = e.touches[0].clientY;
  let val = 1 - ((touchY - rect.top) / rect.height);
  setThrottle(val);
  e.preventDefault();
}, {passive: false});

function setThrottle(v) {
  throttle = Math.max(0, Math.min(1, v));
  const pct = Math.round(throttle * 100);
  document.getElementById('thFill').style.height = pct + '%';
  document.getElementById('thHandle').style.bottom = pct + '%';
  document.getElementById('thHandle').textContent = pct + '%';
}

// --- SENSORS & UI ---
function startApp() {
  if(!window.isSecureContext && location.protocol !== 'file:') {
    alert("Sensor butuh HTTPS atau localhost. Cek Chrome Flags.");
  }
  
  if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(response => {
      if (response == 'granted') initSensors();
    });
  } else {
    initSensors();
  }
  document.getElementById('splashOv').classList.add('hidden');
  connect();
}

function initSensors() {
  window.addEventListener('deviceorientation', e => {
    curRoll = (e.gamma || 0) - rollOff;
    curPitch = (e.beta || 0) - pitchOff;
    updateUI();
  });
}

function updateUI() {
  document.getElementById('dRoll').textContent = Math.round(curRoll) + 'Â°';
  document.getElementById('dPitch').textContent = Math.round(curPitch) + 'Â°';
  drawHorizon(curRoll, curPitch);
}

function drawHorizon(roll, pitch) {
  const s = canvas.width = 200;
  const h = canvas.height = 200;
  const r = s/2;
  ctx.clearRect(0,0,s,h);
  ctx.save();
  ctx.translate(r,r);
  ctx.rotate(roll * Math.PI / 180);
  
  // Sky
  ctx.fillStyle = "#1d2a35";
  ctx.beginPath(); ctx.arc(0,0, r-5, 0, Math.PI*2); ctx.fill();
  
  // Ground
  ctx.fillStyle = "#ff8c0022";
  ctx.beginPath(); ctx.arc(0,0, r-5, 0, Math.PI); ctx.fill();
  
  // Line
  ctx.strokeStyle = "white"; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(-r+10, 0); ctx.lineTo(r-10, 0); ctx.stroke();
  ctx.restore();
}

// --- CONTROL LOOP ---
let loop = null;
function startDataLoop() {
  stopDataLoop();
  loop = setInterval(() => {
    if(ws && ws.readyState === 1 && armed) {
      const data = {
        t: Math.round(throttle * 100),
        r: Math.round(curRoll),
        p: Math.round(curPitch)
      };
      ws.send(JSON.stringify(data));
    }
  }, cfg.rate);
}
function stopDataLoop() { clearInterval(loop); }

function toggleArm() {
  armed = !armed;
  const btn = document.getElementById('armBtn');
  const sts = document.getElementById('dSts');
  if(armed) {
    btn.textContent = "SYSTEM ARMED";
    btn.className = "btn btn-danger";
    sts.textContent = "LIVE"; sts.style.color = "var(--green)";
  } else {
    btn.textContent = "ARM SYSTEM";
    btn.className = "btn btn-primary";
    sts.textContent = "SAFE"; sts.style.color = "var(--gt-orange)";
    setThrottle(0);
  }
}

function calibrate() {
  rollOff += curRoll; pitchOff += curPitch;
}

function openCfg() { document.getElementById('cfgOv').classList.remove('hidden'); }
function saveCfg() {
  cfg.ip = document.getElementById('cIp').value;
  document.getElementById('cfgOv').classList.add('hidden');
  connect();
}
</script>
</body>
</html>
